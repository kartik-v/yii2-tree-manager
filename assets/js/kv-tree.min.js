/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2015
 * @package yii2-tree-manager
 * @version 1.0.6
 *
 * Tree View Validation Module.
 *
 * Author: Kartik Visweswaran
 * Copyright: 2015 - 2016, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */!function(e){"use strict";var t="kvtree",a={create:"create",createR:"create-root",trash:"remove",moveU:"move-up",moveD:"move-down",moveL:"move-left",moveR:"move-right",refresh:"refresh"},o=function(t,a){return null===t||void 0===t||0===t.length||a&&""===e.trim(t)},n=function(e){return e.replace(/[\-\[\]\/\{}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},i=function(e,t){e.removeClass(t).addClass(t)},r=function(e){return e.split("").reduce(function(e,t){return e=(e<<5)-e+t.charCodeAt(0),e&e},0)},s=function(){var e=0;return function(t,a){clearTimeout(e),e=setTimeout(t,a)}}(),l={timeout:3e5,data:{},remove:function(e){delete l.data[e]},exist:function(e){return!!l.data[e]&&(new Date).getTime()-l.data[e]._<l.timeout},get:function(e){return l.data[e].data},set:function(t,a,o){l.remove(t),l.data[t]={_:(new Date).getTime(),data:a},e.isFunction(o)&&o(a)}},d=function(t,a){var o=this;o.$element=e(t),o.init(a),o.listen()};d.prototype={constructor:d,init:function(t){var o=this;e.each(t,function(e,t){o[e]=t}),o.btns=e.extend({},a,o.btns),o.$tree=e("#"+o.treeId),o.$treeContainer=o.$tree.parent(),o.$detail=e("#"+o.detailId),o.$toolbar=e("#"+o.toolbarId),o.$wrapper=e("#"+o.wrapperId),o.$searchContainer=o.$wrapper.find(".kv-search-container"),o.$search=o.$wrapper.find(".kv-search-input"),o.$clear=o.$wrapper.find(".kv-search-clear"),o.select(o.$element.data("key"),!0),l.timeout=o.cacheTimeout,o.selectNodes(),o.validateTooltips()},validateTooltips:function(){var e=this;e.showTooltips&&(e.$toolbar.find(".btn").tooltip(),e.$detail.find(".btn").tooltip())},trigAlert:function(t,a){var o=this.alertFadeDuration;a&&e.isFunction(a)||(a=function(){}),setTimeout(function(){t.fadeOut(o,a())},2*o)},selectNodes:function(){var t=this,a=t.$element.val();if(0!==a.length&&!o(a)){var n=t.$tree.find("li");n.removeClass("kv-selected"),a=a.split(","),e(a).each(function(e,a){i(t.$tree.find('li[data-key="'+a+'"]'),"kv-selected")})}},raise:function(e){var t=this;arguments.length>1?t.$element.trigger(e,arguments[1]):t.$element.trigger(e)},enableToolbar:function(){var e=this;e.$toolbar.find("button").removeAttr("disabled")},disableToolbar:function(){var e=this;e.$toolbar.find("button").attr("disabled",!0),e.$toolbar.find(".kv-"+e.btns.createR).removeAttr("disabled")},enable:function(e){var t=this;t.$toolbar.find(".kv-"+t.btns[e]).removeAttr("disabled")},disable:function(e){var t=this;t.$toolbar.find(".kv-"+t.btns[e]).attr("disabled",!0)},showAlert:function(e,t,a){var o=this,n=o.$detail,i=n.find(".alert-"+t);n.find(".kv-select-node-msg").remove(),i.removeClass("hide").hide().find("div").remove(),i.append("<div>"+e+"</div>").fadeIn(o.alertFadeDuration,function(){o.trigAlert(i,a)})},removeAlert:function(){var e=this;e.$detail.find(".alert").addClass("hide")},renderForm:function(a,n,s){var l=this,d=l.$detail,c=n||"",v=s||!1,f=r(a+l.modelClass+l.isAdmin+c),u=d.find("form"),h=l.actions.manage,m=h&&-1!==h.indexOf("?")?"&":"?";h+=encodeURI(m+t+"="+f),l.formViewBegin=!0,l.parseCache(),l.removeAlert(),e.ajax({type:"post",dataType:"json",data:{id:a,modelClass:l.modelClass,isAdmin:l.isAdmin,formAction:l.formAction,formOptions:l.formOptions,parentKey:c,iconsList:l.iconsList,currUrl:l.currUrl,softDelete:l.softDelete,showFormButtons:l.showFormButtons,showIDAttribute:l.showIDAttribute,multiple:l.multiple,nodeView:l.nodeView,nodeAddlViews:l.nodeAddlViews,breadcrumbs:l.breadcrumbs},url:h,cache:!0,beforeSend:function(e,t){l.raise("treeview.beforeselect",[a,e,t]),u.length&&u.off().yiiActiveForm("destroy").remove(),d.html(""),i(d,"kv-loading")},success:function(e,t,n){var i="error"===e.status?"treeview.selecterror":"treeview.selected";d.html(e.out),l.raise(i,[a,e,t,n]),d.removeClass("kv-loading"),d.find('button[type="reset"]').on("click",function(){l.removeAlert()}),l.removeAlert(),v===!1||o(v.out)||l.showAlert(v.out,v.type)},error:function(e,t,o){l.raise("treeview.selectajaxerror",[a,e,t,o])},complete:function(e){l.raise("treeview.selectajaxcomplete",[a,e]),l.validateTooltips()}})},select:function(t,a,n){if(!o(t)){var r,s=this,l=a||!1,d=n||!1,c=s.$tree.find('li[data-key="'+t+'"]>.kv-tree-list .kv-node-detail');0!==c.length&&(s.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(c,"kv-focussed"),l?s.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(c).length>0&&t.removeClass("kv-collapsed")}):s.renderForm(t,null,d),r=c.closest("li"),r.hasClass("kv-disabled")?s.disableToolbar():s.enableToolbar(),(!r.data("removable")||r.hasClass("kv-inactive")&&s.softDelete||!r.data("removableAll")&&r.hasClass("kv-parent"))&&s.disable("trash"),r.data("movable-u")||s.disable("moveU"),r.data("movable-d")||s.disable("moveD"),r.data("movable-l")||s.disable("moveL"),r.data("movable-r")||s.disable("moveR"),s.parseParentFlag(t))}},parseParentFlag:function(t){var a,o=this,n=o.$detail.find('input[class="kv-parent-flag"]'),i=o.$tree.find('li[data-key="'+t+'"]');n.each(function(){var t=e(this);a=t.closest("div.checkbox"),a.removeClass("disabled"),i.hasClass("kv-parent")?t.removeAttr("disabled"):(t.attr("disabled","disabled"),a.addClass("disabled"))})},remove:function(){var t,a,o=this,n=o.$tree.find("li .kv-node-detail.kv-focussed"),r=n.closest("li"),s=o.messages,l=o.$detail,d=l.find("form");if((0!==n.length||r.hasClass("kv-empty"))&&!r.hasClass("kv-disabled")&&window.confirm(s.removeNode)){if(a=function(e){var a=e?s.emptyNodeRemoved:s.nodeRemoved,n=r.closest("li.kv-parent");r.remove(),t=l.find(".alert"),o.formViewBegin=!1,l.find(".kv-select-node-msg").remove(),t.length&&l.before(t).html("").append(t),n.find("li").length||n.removeClass("kv-parent"),o.showAlert(a,"info",function(){l.append('<h4 class="alert text-center kv-select-node-msg" style="display:none;">'+s.selectNode+"</h4>"),setTimeout(function(){o.formViewBegin||l.find(".kv-select-node-msg").fadeIn(o.alertFadeDuration)},o.alertFadeDuration)})},r.hasClass("kv-empty"))return void a(!0);var c=r.data("key");e.ajax({type:"post",dataType:"json",data:{id:c,"class":o.modelClass,softDelete:o.softDelete},url:o.actions.remove,beforeSend:function(e,t){o.raise("treeview.beforeremove",[c,e,t]),d.hide(),o.removeAlert(),i(l,"kv-loading")},success:function(e,t,n){if("success"===e.status){if((o.isAdmin||o.showInactive)&&o.softDelete){o.showAlert(e.out,"info"),d.show();var s=o.modelClass.split("\\").pop(),v=d.find('input[name="'+s+'[active]"]');v.val(!1),v.prop("checked",!1),i(r,"kv-inactive"),r.data("removableAll")&&i(r.find("li"),"kv-inactive"),i(r,"kv-inactive")}else a();o.softDelete||o.disableToolbar(),o.raise("treeview.remove",[c,e,t,n])}else o.showAlert(e.out,"danger"),d.show(),o.raise("treeview.removeerror",[c,e,t,n]);l.removeClass("kv-loading")},error:function(e,t,a){o.raise("treeview.removeajaxerror",[c,e,t,a])},complete:function(e){o.raise("treeview.removeajaxcomplete",[e])}})}},move:function(t){var a,o,n,r,s=this,d=s.$tree.find("li .kv-node-detail.kv-focussed"),c=d.closest("li"),v=s.messages,f=s.$detail,u=null,h=!1,m=function(){};if(0!==d.length&&!c.hasClass("kv-disabled")){if(c.hasClass("kv-empty"))return void window.alert(v.nodeNewMove);switch(t){case"u":if(u=c.prev(),0===u.length)return void window.alert(v.nodeTop);m=function(){u.before(c)};break;case"d":if(u=c.next(),0===u.length)return void window.alert(v.nodeBottom);m=function(){u.after(c)};break;case"l":if(u=c.parent("ul").closest("li.kv-parent"),0===u.length)return void window.alert(v.nodeLeft);r=u.parent("ul"),h=r.hasClass("kv-tree"),h&&(u=r.children("li:last-child")),m=function(){u.after(c),0===u.find("li").length&&(u.removeClass("kv-parent"),u.find("ul").remove())};break;case"r":if(u=c.prev(),0===u.length)return void window.alert(v.nodeRight);m=function(){u.find("li").length>0?u.children("ul").append(c):(i(u,"kv-parent"),e(document.createElement("ul")).appendTo(u).append(c))};break;default:throw"Invalid move direction '"+t+"'"}a=c.data("key"),o=u.data("key"),e.ajax({type:"post",dataType:"json",data:{idFrom:a,idTo:o,"class":s.modelClass,dir:t,allowNewRoots:s.allowNewRoots},url:s.actions.move,beforeSend:function(e,n){s.raise("treeview.beforemove",[t,a,o,e,n]),i(s.$treeContainer,"kv-loading-search")},success:function(i,r,d){f.length>0&&s.removeAlert(),"success"===i.status?(m(),"l"===t||"r"===t?(l.timeout=0,n=f.length>0?{out:i.out,type:"success"}:!1,s.select(a,!1,n),l.timeout=s.cacheTimeout):f.length>0&&s.showAlert(i.out,"success"),s.$tree.find("li.kv-collapsed").each(function(){e(this).has(c).length>0&&e(this).removeClass("kv-collapsed")}),s.raise("treeview.move",[t,a,o,i,r,d])):f.length>0&&(s.showAlert(i.out,"danger"),s.raise("treeview.moveerror",[t,a,o,i,r,d])),s.$treeContainer.removeClass("kv-loading-search")},error:function(e,n,i){f.length>0&&(s.removeAlert(),s.showAlert(i,"danger")),s.$treeContainer.removeClass("kv-loading-search"),s.raise("treeview.moveajaxerror",[t,a,o,e,n,i])},complete:function(e){s.raise("treeview.moveajaxcomplete",[e])}})}},setSelected:function(){var t=this,a="",n="";t.$tree.find(".kv-selected").each(function(){var t=e(this),i=o(a)?"":",";a+=i+t.data("key"),n+=i+t.find(">.kv-tree-list .kv-node-label").text()}),t.$element.val(a),t.raise("treeview.change",[a,n]),t.raise("change")},getNewNode:function(){var e=this;return'<div class="kv-tree-list" tabindex="-1">\n   <div class="kv-node-indicators">&nbsp;</div>\n   <div class="kv-node-detail kv-focussed">\n       <span class="kv-node-label">'+e.messages.emptyNode+"</span>\n   </div>\n</div>"},create:function(){var t,a,o,n,r,s=this,l=s.$tree.find("li .kv-node-detail.kv-focussed"),d=l.closest("li"),c=s.messages;return d.hasClass("kv-disabled")?void window.alert(c.nodeDisabled):0===l.length||d.hasClass("kv-empty")?void window.alert(c.invalidCreateNode):(s.$toolbar.find(".kv-"+s.btns.trash).removeAttr("disabled"),r=d.find("> ul > li.kv-empty"),r.length>0?(a=r.data("key").replace("empty-",""),s.renderForm(null,a),l.removeClass("kv-focussed"),void i(r.find(".kv-node-detail"),"kv-focussed")):(r=e(document.createElement("li")).attr({"data-key":"empty-"+d.data("key"),"class":"kv-empty"}),o=s.getNewNode(),l.removeClass("kv-focussed"),r.append(o),d.hasClass("kv-parent")?d.children("ul").append(r):(i(d,"kv-parent"),t=e(document.createElement("ul")).append(r),d.append(t)),s.renderForm(null,d.data("key")),n=r.find(".kv-node-detail"),d.removeClass("kv-collapsed"),r.children(".kv-tree-list").focus(),n.on("click",function(){s.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(n,"kv-focussed"),a=r.data("key").replace("empty-",""),s.renderForm(null,a),s.$toolbar.find(".kv-"+s.btns.trash).removeAttr("disabled")}),void s.raise("treeview.create",[parent])))},createRoot:function(){var t=this,a=t.$tree.find(".kv-tree"),o=a.children("li.kv-empty");if(t.$tree.find(".kv-node-detail").removeClass("kv-focussed"),o.length>0)return i(o.find(".kv-node-detail"),"kv-focussed"),void t.renderForm(null,"root");var n=t.getNewNode(),r=e(document.createElement("li")).attr({"data-key":"empty-root","class":"kv-empty"});r.html(n),a.append(r),t.renderForm(null,"root");var s=r.find(".kv-node-detail");i(s,"kv-focussed"),t.$toolbar.find(".kv-"+t.btns.trash).removeAttr("disabled"),s.on("click",function(){t.$tree.find(".kv-node-detail").removeClass("kv-focussed"),i(s,"kv-focussed"),t.renderForm(null,"root"),t.$toolbar.find(".kv-"+t.btns.trash).removeAttr("disabled")}),t.raise("treeview.createroot")},toggle:function(e){var t=this,a=e.closest("li.kv-parent"),o=a.data("key");a.hasClass("kv-collapsed")?(a.removeClass("kv-collapsed"),t.raise("treeview.expand",[o])):(i(a,"kv-collapsed"),t.raise("treeview.collapse",[o]))},toggleAll:function(e,t){var a=this;return"expand"===e?(a.$tree.removeClass("kv-collapsed"),a.$tree.find(".kv-collapsed").removeClass("kv-collapsed"),void(t&&a.raise("treeview.expandall"))):(i(a.$tree.find("li.kv-parent"),"kv-collapsed"),i(a.$tree,"kv-collapsed"),void(t&&a.raise("treeview.collapseall")))},check:function(e){var t=this,a=e===!0,o=a?t.$tree:e.closest("li"),n=a?"":o.data("key"),r=t.multiple&&0!=t.multiple;if(!(o.hasClass("kv-disabled")||a&&!r)){if(o.hasClass("kv-selected"))o.removeClass("kv-selected"),r?o.find("li:not(.kv-disabled)").removeClass("kv-selected"):(t.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),t.$element.val(""),t.raise("treeview.change",["",""]),t.raise("change")),t.raise("treeview.unchecked",[n]);else{if(r)i(o.find("li:not(.kv-disabled)"),"kv-selected");else{t.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),t.$element.val(n);var s=o.find(">.kv-tree-list .kv-node-label").text();t.raise("treeview.change",[n,s]),t.raise("change")}i(o,"kv-selected"),t.raise("treeview.checked",[n])}r&&t.setSelected()}},clear:function(){var e=this;e.$treeContainer.removeClass("kv-loading-search"),e.$tree.find(".kv-node-label").removeClass("kv-highlight")},parseCache:function(){var t=this;return t.enableCache?void e.ajaxPrefilter(function(t,a){if(t.cache){var o=a.beforeSend||e.noop,n=a.success||e.noop,i=a.url;t.cache=!1,t.beforeSend=function(){return o(),l.exist(i)?(n(l.get(i)),!1):!0},t.success=function(e){l.set(i,e,n)}}}):!1},listen:function(){var t=this;t.$tree.find(".kv-node-toggle").each(function(){e(this).on("click",function(){t.toggle(e(this))})}),t.$tree.find(".kv-node-checkbox:not(.kv-disabled)").each(function(){e(this).on("click",function(){t.check(e(this))})}),t.$treeContainer.find(".kv-root-node-toggle").on("click",function(){var a=e(this),o=a.closest(".kv-tree-container");o.hasClass("kv-collapsed")?t.toggleAll("expand",!0):t.toggleAll("collapse",!0)}),t.$treeContainer.find(".kv-root-node-checkbox").on("click",function(){t.check(!0)}),t.$search.on("keyup",function(){var a=e(this).val();t.clear(),0!==a.length&&(i(t.$treeContainer,"kv-loading-search"),s(function(){t.toggleAll("collapse",!1),a=n(a),t.$tree.find(".kv-node-label").each(function(){var o=e(this),n=o.text(),r=n.search(new RegExp(a,"i"));0>r?o.removeClass("kv-highlight"):(i(o,"kv-highlight"),t.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(o).length>0&&t.removeClass("kv-collapsed")}))}),t.$treeContainer.removeClass("kv-loading-search"),t.raise("treeview.search")},1500))}),t.$clear.on("click",function(){t.$search.val(""),t.clear()}),t.$tree.find(".kv-node-detail").each(function(){e(this).on("click",function(){var a=e(this),o=a.closest("li"),n=o.data("key");return t.$tree.hasClass("kv-tree-input-widget")?(a.removeClass("kv-focussed"),void t.check(o)):void(a.hasClass("kv-focussed")||(t.select(n),t.removeAlert(),t.raise("treeview.select",[n])))})}),t.$toolbar.find(".kv-"+t.btns.create).on("click",function(){t.create()}),t.$toolbar.find(".kv-"+t.btns.createR).on("click",function(){t.createRoot()}),t.$toolbar.find(".kv-"+t.btns.trash).on("click",function(){t.remove()}),t.$toolbar.find(".kv-"+t.btns.moveU).on("click",function(){t.move("u")}),t.$toolbar.find(".kv-"+t.btns.moveD).on("click",function(){t.move("d")}),t.$toolbar.find(".kv-"+t.btns.moveL).on("click",function(){t.move("l")}),t.$toolbar.find(".kv-"+t.btns.moveR).on("click",function(){t.move("r")}),t.$detail.find(".alert").each(function(){var a=e(this);a.hasClass("hide")||(a.hide().fadeIn(1500),t.trigAlert(a))})},expandAll:function(){this.toggleAll("expand")},collapseAll:function(){this.toggleAll("collapse")},checkAll:function(){var e=this;e.$tree.removeClass("kv-selected"),e.check(!0)},uncheckAll:function(){var e=this;i(e.$tree,"kv-selected"),e.check(!0)},checkNode:function(e){var t=this,a=t.$tree.find('li[data-key="'+e+'"]');a.length&&(a.removeClass("kv-selected"),t.check(a))},uncheckNode:function(e){var t=this,a=t.$tree.find('li[data-key="'+e+'"]');a.length&&(i(a,"kv-selected"),t.check(a))}},e.fn.treeview=function(t){var a,o,n,i=Array.apply(null,arguments);return i.shift(),this.each(function(){a=e(this),o=a.data("treeview"),n="object"==typeof t&&t,o||(o=new d(this,e.extend({},e.fn.treeview.defaults,n,e(this).data())),a.data("treeview",o)),"string"==typeof t&&o[t].apply(o,i)})},e.fn.treeview.defaults={btns:{},treeId:"",detailId:"",toolbarId:"",wrapperId:"",showTooltips:!0,alertFadeDuration:1e3,cacheTimeout:3e5,showInactive:!1,actions:{manage:"",move:"","delete":""},messages:{emptyNode:"",nodeDisabled:"",invalidCreateNode:"",removeNode:"",nodeRemoved:"",emptyNodeRemoved:"",nodeNewMove:"",nodeTop:"",nodeBottom:"",nodeLeft:"",nodeRight:""},breadcrumbs:{}},e.fn.treeview.Constructor=d}(window.jQuery);